任何前端框架，最主要的核心功能就是渲染视图。

## VNode

Vue 的内部渲染机制中引入 Virtual DOM 去抽象描述真实的 DOM。Virtual DOM 中每一个节点叫做 VNode，VNode 本质上是用来描述 DOM 的 JavaScript 对象。

```html
<button class="btn" style="width:100px;height:50px">click me</button>
```

```javascript
const vnode = {

  type: 'button',

  props: { 
    'class': 'btn',
    style: {
      width: '100px',
      height: '50px'
    }
  },
  children: 'click me'
}

```

我们可以用 vnode 这样表示`<button>`节点。一个 VNode 节点属性最主要的是 `type`，`props`，`children`。

引入 VNode 的好处：

1. 任何常规的 GUI 都能用类 DOM 数据结构去描述，引入 VNode，做一层界面抽象，提供了**跨平台**能力。
2. 提供了界面**组件化**的抽象能力。

## 组件

<img src="${images}/components.png" alt="Component Tree" style="zoom:50%;" />

几乎任意类型的应用界面都可以抽象为一个组件树。

例如，你可能会有页头、侧边栏、内容区等组件，每个组件又包含了其它的像导航链接、博文之类的组件。

**抽象组件化后提供了代码复用能力**。

## 

```typescript
// packages/runtime-core/src/vnode.ts
export type VNodeTypes =
  | string
  | VNode
  | Component
  | typeof Text
  | typeof Static
  | typeof Comment
  | typeof Fragment
  | typeof TeleportImpl
  | typeof SuspenseImpl

export interface VNode<
  HostNode = RendererNode,
  HostElement = RendererElement,
  ExtraProps = { [key: string]: any }
> {
  type: VNodeTypes
  props: (VNodeProps & ExtraProps) | null
  key: string | number | null
  ref: VNodeNormalizedRef | null
	...
}
```



template + component-config-object + data = vnode



## 组件渲染流程

1. 创建应用实例 createApp
2. 挂载 mount
3. 创建 vnode
4. 渲染 vnode（diff）
5. 生成 DOM（patch）



### 创建应用实例

```javascript
// 在 Vue.js 3.0 中，标准初始化一个应用的方式如下
import { createApp } from 'vue'
import App from './app'
const app = createApp(App)
app.mount('#app')

-------------------------------------------------------------

// web 平台下，runtime-dom 包下可以找到 createApp 方法定义
// packages/runtime-dom/src/index.ts
const createApp = ((...args) => {
  // 创建 app 对象
  const app = ensureRenderer().createApp(...args)

  const { mount } = app

  // 重写 mount 方法
  app.mount = (containerOrSelector) => {
    // ...
  }

  return app
})

```

1. 创建自定义渲染器

   ```javascript
   // packages/runtime-dom/src/index.ts
   
   const app = ensureRenderer().createApp(...args)
   
   // 延迟创建渲染，方便 tree-shakable
   function ensureRenderer() {
     return renderer || (renderer = createRenderer<Node, Element>(rendererOptions))
   }
   
   --------------------------------------------------------
   
   // packages/runtime-core/src/renderer.ts
   
   // createRenderer 是 vue 自定义渲染器的核心方法
   function createRenderer(options) {
     return baseCreateRenderer(options)
   }
   
   function baseCreateRenderer(options) {
     function render(vnode, container) {
       // 组件渲染的核心逻辑
     }
   
     return {
       render,
       createApp: createAppAPI(render)
     }
   }
   ```

   

