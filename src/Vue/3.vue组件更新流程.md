---
tags:
 - vue
 - 更新渲染
---
# Vue 组件更新渲染流程

Vue 最重要的特性之一就是数据驱动视图，数据的变化会触发组件的更新渲染。Vue 通过副作用渲染函数 `setupRenderEffect` 把组件的渲染跟响应式数据建立关联。

```javascript
// packages/runtime-core/src/renderer.ts
const setupRenderEffect: SetupRenderEffectFn = (
    instance,
    initialVNode,
    container,
    anchor,
    parentSuspense,
    isSVG,
    optimized
  ) => {
    // 创建响应式的副作用渲染函数
    instance.update = effect(function componentEffect() {
      if (!instance.isMounted) {
        // 初始渲染
      } else {
        /**
         * 更新渲染
         * 触发更新有两种条件：
         * 1. 自身 state 发生变化触发更新 (next: null)
         * 2. 父组件发生更新导致子组件更新 (next: VNode)
         * next 表示新的组件 vnode
         */
        let { next, bu, u, parent, vnode } = instance
        let originNext = next

        if (next) {
          next.el = vnode.el
          // 更新组件 vnode 节点信息
          updateComponentPreRender(instance, next, optimized)
        } else {
          next = vnode
        }

        // 重新渲染子树
        const nextTree = renderComponentRoot(instance)
        
        // 缓存旧的子树 vnode
        const prevTree = instance.subTree
        // 更新子树 vnode
        instance.subTree = nextTree

        // 组件更新核心逻辑，根据新旧子树 vnode 做 patch
        patch(
          prevTree,
          nextTree,
          // parent may have changed if it's in a teleport
          hostParentNode(prevTree.el!)!,
          // anchor may have changed if it's in a fragment
          getNextHostNode(prevTree),
          instance,
          parentSuspense,
          isSVG
        )
       
        // 缓存更新后的 DOM 节点
        next.el = nextTree.el
      }
    }, __DEV__ ? createDevEffectOptions(instance) : prodEffectOptions)
  }
```

组件触发更新有 2 种场景：

1. 自身 state 发生更新
2. 父组件发生更新导致子组件更新

组件的更新渲染主要任务：

1. 更新组件 vnode 节点
2. 渲染新的 subTree
3. 根据新旧子树 vnode 执行 patch 逻辑

## 核心更新流程：diff 算法

进入 patch 阶段，就是 Vue 核心 diff 更新流程。
 
diff 组件

diff element