---
discussionID: QyCS9neDAqOKlfGCBQXzW
release: true
top: 0
tags:
 - javascript
 - å¼‚æ­¥
 - ç¼–ç¨‹è¯­è¨€
---

# JavaScript å¼‚æ­¥ç¼–ç¨‹

- JavaScript å¼‚æ­¥ç¼–ç¨‹
  - [å¼‚æ­¥ç¼–ç¨‹](#å¼‚æ­¥ç¼–ç¨‹)
  - [JavaScript çš„å¼‚æ­¥åŸç†ï¼šäº‹ä»¶å¾ªç¯ + å›è°ƒé˜Ÿåˆ—](#javascript-çš„å¼‚æ­¥åŸç†å•çº¿ç¨‹äº‹ä»¶å¾ªç¯--å›è°ƒé˜Ÿåˆ—)
  - [JavaScript å¼‚æ­¥ç¼–ç¨‹èŒƒå¼](#javascript-å¼‚æ­¥ç¼–ç¨‹)

## å¼‚æ­¥ç¼–ç¨‹

å¼‚æ­¥ç¼–ç¨‹æ˜¯ä¸€ç§åœ¨ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­ä¸é˜»å¡çš„ç¼–ç¨‹æ–¹å¼ã€‚åœ¨ç¼–ç¨‹è¯­è¨€ä¸­ï¼ŒåŒæ­¥ç¼–ç¨‹æ„å‘³ç€ä»£ç ä»»åŠ¡ä¸€ä¸ªæ¥ä¸€ä¸ªæ‰§è¡Œå‘ç”Ÿï¼Œä»»åŠ¡çš„æ‰§è¡Œæµç¨‹ä¸ä»£ç çš„ç¼–å†™ã€è°ƒç”¨é¡ºåºæ˜¯ä¸€æ ·çš„ï¼›è€Œåœ¨å¼‚æ­¥ç¼–ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†ç¼–å†™å¼‚æ­¥å•å…ƒï¼Œæ‰§è¡Œæµä¸ä»»åŠ¡çš„ç¼–å†™ã€è°ƒç”¨é¡ºåºä¸å†ä¸€è‡´ï¼Œä»»åŠ¡æ‰§è¡Œæ—¶æœºä¸å†åƒåŒæ­¥ç¼–ç¨‹é‚£æ ·ç›´è§‚ï¼Œå®ƒä»¬ç»Ÿä¸€ç”±å¼‚æ­¥è¿è¡Œæ—¶å¹¶å‘è°ƒåº¦å†³å®šã€‚

![](./images/2024-06-12-1423.excalidraw.svg)

è¿™æ ·åšçš„å¥½å¤„å°±æ˜¯å…è®¸ç¨‹åºåœ¨ç­‰å¾…æŸäº›æ“ä½œå®Œæˆæ—¶ç»§ç»­æ‰§è¡Œå…¶ä»–ä»»åŠ¡ï¼Œä»è€Œæé«˜ç¨‹åºçš„å¹¶å‘æ€§å’Œå“åº”æ€§ã€‚ä½†ç¼–ç¨‹æ¨¡å‹ç›¸å¯¹å¤æ‚ä¸€äº›ï¼Œå› ä¸ºä½ éœ€è¦å¤„ç†ä»»åŠ¡å®Œæˆé€šçŸ¥ï¼Œä»¥åŠåœ¨**å¤šä¸ªä»»åŠ¡é—´ååŒæ“ä½œ**ï¼ˆä»£ç æ˜¯å¯å¼‚æ­¥æ‰§è¡Œï¼Œä½†ä¸šåŠ¡é€»è¾‘å¿…é¡»æ˜¯åŒæ­¥å…³ç³»ï¼‰æ˜¯ç¼–ç¨‹ä¸­å¼‚æ­¥å¤„ç†çš„å…³é”®è§£å†³ä¹‹é“ã€‚

> è¿™é‡Œå¯èƒ½éœ€è¦æåŠä¸€ç‚¹çš„æ˜¯å¤šçº¿ç¨‹å’Œå¼‚æ­¥çš„åŒºåˆ«å…³ç³»ï¼šçº¿ç¨‹æ˜¯ç³»ç»ŸåŠŸèƒ½çš„æ‰§è¡Œå•ä½ï¼Œè€Œå¼‚æ­¥æè¿°çš„æ˜¯ä»»åŠ¡ä¹‹é—´çš„åä½œå…³ç³»ï¼Œæˆ‘ä»¬å¯ä»¥å°†å¤šæ¡å¼‚æ­¥çš„ä»»åŠ¡æµåˆ†åˆ«åº”ç”¨äºå¤šçº¿ç¨‹å½“ä¸­å»å¹¶å‘æ‰§è¡Œï¼Œä½†å¹¶å‘ä¸ä¸€å®šæ˜¯ç”¨å¤šçº¿ç¨‹ä¹Ÿå¯ä»¥æ˜¯ç”¨å•çº¿ç¨‹ï¼Œå…·ä½“è¦çœ‹å¼‚æ­¥æ¡†æ¶/è¿è¡Œæ—¶çš„å®ç°æ–¹å¼ã€‚æ•…å¤šçº¿ç¨‹åªæ˜¯å¼‚æ­¥ç¼–ç¨‹å®ç°çš„ä¸€ç§æŠ€æœ¯å®ç°ã€‚

æ€»çš„æ¥è¯´ï¼Œå¼‚æ­¥ç¼–ç¨‹æ˜¯ä¸€ç§åº”ç”¨ç¨‹åºçº§åˆ«ã€è¯­è¨€æˆ–æ¡†æ¶å±‚é¢å®ç°çš„å¹¶å‘ç¼–ç¨‹æ¨¡å‹ï¼Œæ—¨åœ¨éé˜»å¡åœ°æ‰§è¡Œä»£ç ï¼Œå…è®¸ç¨‹åºåœ¨ç­‰å¾…é•¿æ—¶é—´æ“ä½œæ—¶ç»§ç»­æ‰§è¡Œå…¶ä»–ä»»åŠ¡ã€‚

## JavaScript çš„å¼‚æ­¥åŸç†ï¼šäº‹ä»¶å¾ªç¯ + å›è°ƒé˜Ÿåˆ—

JavaScript æ˜¯ä¸€é—¨å•çº¿ç¨‹è¯­è¨€ï¼Œè¯­è¨€å±‚é¢æ²¡æœ‰æä¾›å¤šçº¿ç¨‹ç¼–ç¨‹èƒ½åŠ›ï¼ŒåŒæ—¶ä¹Ÿè·Ÿå¤§å¤šæ•°åŒæ­¥ç¼–ç¨‹è¯­è¨€ä¸€æ ·ï¼Œä¸€æ—¦é‡åˆ°è€—æ—¶ä»»åŠ¡æ•´ä¸ªçº¿ç¨‹å°±ä¼šè¢«é˜»å¡ã€‚å› æ­¤å¹¶å‘æ€§æ˜¯æŒ‡äº‹ä»¶å¾ªç¯åœ¨å®Œæˆå…¶ä»–å·¥ä½œåæ‰§è¡Œ JavaScript å›è°ƒå‡½æ•°çš„èƒ½åŠ›ã€‚

åœ¨ ES6 ä¹‹å‰ï¼ŒJavaScript è¯­è¨€æœ¬èº«å¹¶æ²¡æœ‰ä»»ä½•å¼‚æ­¥èƒ½åŠ›ã€‚JavaScript çš„å¼‚æ­¥å®ç°ä¸»è¦æ˜¯ç”±å®¿ä¸»ç¯å¢ƒæä¾›çš„è¿è¡Œæ—¶èƒ½åŠ›ï¼Œä½¿ç”¨å¼‚æ­¥ API + å¼‚æ­¥å›è°ƒçš„æ¨¡å¼ï¼š

```js
// å¼‚æ­¥å›è°ƒ
function foo() {
    alert("Hello");
}

// å¼‚æ­¥ API
setTimeout(foo, 3000)
```

ä½†å¯¹äºè¿™æ ·çš„æ¨¡å¼ï¼Œåœ¨æ‰§è¡Œç¯å¢ƒå±‚é¢æ˜¯å¦‚ä½•æ”¯æŒï¼Ÿæˆ‘ä»¬åº”è¯¥æœ‰ä¸€ä¸ªæ„Ÿæ€§çš„è®¤çŸ¥ï¼šä¸€ä¸ª JavaScript å¼•æ“ä¼šå¸¸é©»äºå†…å­˜ä¸­ï¼Œä¸æ–­å¾ªç¯ç­‰å¾…ç€ã€æ‰§è¡Œç€å›è°ƒé˜Ÿåˆ—é‡Œçš„ä»»åŠ¡ï¼›è€Œå½“å‘èµ·å¼‚æ­¥è°ƒç”¨å®Œæˆæ—¶ï¼Œç³»ç»Ÿä¼šå°†å¼‚æ­¥å›è°ƒä»»åŠ¡æ”¾è¿›é˜Ÿåˆ—é‡Œã€‚æ€»çš„æ¥è¯´ï¼ŒJavaScript çš„å¹¶å‘æ¨¡å‹æ˜¯ä¸€ä¸ªå•çº¿ç¨‹äº‹ä»¶å¾ªç¯ + å›è°ƒé˜Ÿåˆ—ï¼š

> ä»¥ä¸‹æ˜¯æµè§ˆå™¨äº‹ä»¶å¾ªç¯æ¨¡å‹ä¸­ JavaScript äº¤äº’çš„éƒ¨åˆ†

![](./images/1iHhUyO4DliDwa6xcO5E3A.gif)

ES5 ä¹‹åï¼ŒJavaScript å¼•å…¥äº† Promiseã€‚æˆ‘ä»¬ä¸éœ€è¦å®¿ä¸»çš„å®‰æ’ä»»åŠ¡ï¼ŒJavaScript å¼•æ“æœ¬èº«ä¹Ÿå¯ä»¥å‘èµ·å¼‚æ­¥ä»»åŠ¡äº†ã€‚æˆ‘ä»¬æŠŠå®¿ä¸»ç¯å¢ƒè°ƒåº¦çš„ä»»åŠ¡ç§°ä¸ºå®è§‚ä»»åŠ¡ï¼ŒæŠŠ JavaScript å¼•æ“å†…éƒ¨è°ƒåº¦ä»»åŠ¡ç§°ä¸ºå¾®è§‚ä»»åŠ¡ã€‚å¼•æ“ä¼šå…ˆå¤„ç†å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„å¾®ä»»åŠ¡ï¼Œç›´è‡³æ‰€æœ‰å¾®ä»»åŠ¡æ¸…ç©ºæ‰çœŸæ­£é€€å‡ºï¼Œå¦‚æœåœ¨å¾®ä»»åŠ¡ä¸­å¾ªç¯è§¦å‘æ–°çš„å¾®ä»»åŠ¡ï¼Œé‚£ä¹ˆä¹Ÿå°†è¢«æ¸…å®Œä¸ºæ­¢å°†èƒ½è¿›å…¥ä¸‹ä¸€ä¸ªå®ä»»åŠ¡ã€‚

## JavaScript å¼‚æ­¥ç¼–ç¨‹èŒƒå¼

> ç½‘ä¸Šå¯¹ JavaScript å¼‚æ­¥ç¼–ç¨‹èŒƒå¼ä»‹ç»æœ‰å¾ˆå¤šå¾ˆè¯¦ç»†çš„ï¼Œç¬”è€…å¯¹äºè¿™å—å†…å®¹å°±æŒ‘ç€è®°å½• ğŸ˜Š

- å¼‚æ­¥å›è°ƒ
- å‘å¸ƒè®¢é˜…æ¨¡å¼ï¼šå‘å¸ƒè®¢é˜…æ¨¡å¼è§£å†³äº†å›è°ƒåœ°ç‹±çš„é—®é¢˜ï¼Œä½†å­˜æœ‰é€»è¾‘ç¢ç‰‡åŒ–çš„é—®é¢˜
  - [æ‰‹å†™ EventEmitter å®ç°](https://github.com/laoergege/laoergege-blog/issues/84)
- [Promise](#promise)ï¼šé€šè¿‡é“¾å¼è°ƒç”¨çš„å†™æ³•ä¸ä»…è§£å†³äº†å›è°ƒåœ°ç‹±çš„é—®é¢˜ï¼Œè€Œä¸”çº¿å‹ç®¡ç† Callback çš„æ–¹å¼ä½¿å¾—ç›¸å…³é€»è¾‘å†…èšæé«˜äº†ä¸€å®šçš„å¯è¯»æ€§
  - [Promise å¼‚æ­¥é”™è¯¯](#promise-å¼‚æ­¥é”™è¯¯)
- [Async/Await](#asyncawait)
  - [Generator](#generator)
- å‡½æ•°å“åº”å¼ç¼–ç¨‹ï¼šæ˜¯ä¸€ç§å‘å¸ƒè®¢é˜…æ¨¡å¼å’Œè¿­ä»£æ¨¡å¼çš„ç»“åˆï¼Œç›¸æ¯”å‘å¸ƒè®¢é˜…æ¨¡å¼å¸¦æ¥äº‹ä»¶æ”¯ç¦»ï¼Œå‡½æ•°å“åº”å¼ç¼–ç¨‹åˆ™æŠŠå®ƒä»¬ä¸²è¿èµ·æ¥ï¼Œå½“ä½œäº‹ä»¶æµæ¥å¤„ç†

### Promise

Promise ä»£è¡¨ç€ä¸€ç§æœªæ¥çš„æ‰¿è¯ºï¼Œæœ¬è´¨æ˜¯ä¸€ç§æ•°æ®ç»“æ„ï¼Œå¯ä»¥çœ‹ä½œæ˜¯çŠ¶æ€æœºå’Œè§‚å¯Ÿè€…æ¨¡å¼ç»“åˆã€‚

> [Promises/A+ è§„èŒƒé“¾æ¥åœ°å€](https://promisesaplus.com/)

- Promise å®ä¾‹
  - state  ![å›¾ 2](./images/1654329152719.png)  
    - pending
    - fulfilled
    - rejected
  - result
  - reason: æ˜¯ä¸€ä¸ª Promise é‡Œ reject ä¹‹åè¿”å›çš„æ‹’ç»åŸå› 
  - exception: æ˜¯ä¸€ä¸ªå¼‚å¸¸ï¼Œæ˜¯åœ¨ Promise é‡Œé¢å¯ä»¥ç”¨ throw è¯­å¥æŠ›å‡ºæ¥çš„å€¼
  - thenã€catchã€finally
    - é“¾å¼è°ƒç”¨
    - å»¶è¿Ÿç»‘å®š
    - å€¼ç©¿é€ã€é”™è¯¯å†’æ³¡ï¼šå½“æˆ‘ä»¬ä¸åœ¨ then ä¸­æ”¾å…¥å‚æ•°ï¼Œæˆ–è€…å‚æ•°ä¸ä¸º functionï¼Œä¾‹ï¼špromise.then().then()ï¼Œé‚£ä¹ˆå…¶åé¢çš„ then ä¾æ—§å¯ä»¥å¾—åˆ°ä¹‹å‰ then è¿”å›çš„å€¼
    - è¿”å›å€¼ç©¿é€ï¼šresolve è¿”å›å€¼ï¼Œå¦‚æœè¿”å›å€¼æ˜¯ Promiseï¼Œåˆ™ç›´æ¥è·å–å†…éƒ¨ç»“æœè¿”å›
    - onResolved å’Œ onRejected è¿™ä¸¤é¡¹å‡½æ•°éœ€è¦å¼‚æ­¥è°ƒç”¨
- Promise é™æ€æ–¹æ³•
  - **resolve**
    - å‚æ•°ä¸º Promise å¯¹è±¡ï¼Œç›´æ¥è¿”å›
    - å‚æ•°ä¸º Thenable å¯¹è±¡
    - å…¶ä»–æ•°æ®ç±»å‹ï¼Œä½œä¸ºæ–° Promise çš„ result
  - reject
  - allï¼šæ‰€æœ‰ Promises çŠ¶æ€æˆåŠŸå°±è¿”å›ï¼Œå¦åˆ™è¿”å›å¤±è´¥çš„ Promises
  - allSettledï¼šæ‰€æœ‰çš„ Promise çŠ¶æ€å®Œæˆå°±è¿”å›ï¼Œä¸ç®¡å…¶æ˜¯å¦å¤„ç†æˆåŠŸ
  - anyï¼šä¼˜å…ˆè¿”å›çŠ¶æ€æˆåŠŸçš„ Promiseï¼Œå¦åˆ™è¿”å›å…¨éƒ¨å¤±è´¥ç»“æœ
  - raceï¼šä¼˜å…ˆè¿”å›çŠ¶æ€å®Œæˆçš„ Promise

> [å®ç°çš„ç®€æ˜“ç‰ˆæœ¬ promise.js](https://github.com/laoergege/laoergege-blog/blob/master/content/JavaScript/codes/promise.js)

### Promise å¼‚æ­¥é”™è¯¯

```js
try {
  setTimeout(() => throw new Error("Whoops!"));
} catch (e) {
  console.log(e) // no happend
}
```

å¼‚æ­¥é”™è¯¯æ— æ³•è¢« try catch ç›´æ¥æ•è·ï¼Œå› ä¸ºå¼‚æ­¥ä»£ç çš„æ‰§è¡Œä¸ä¸ try catch çš„ä»£ç åœ¨åŒä¸€ä¸ªè°ƒç”¨æ ˆä¸­ã€‚

å¦‚æœæˆ‘ä»¬æŠŠ Promise å½“ä½œç€ä¸€ç§å¼‚æ­¥ç»“æœï¼Œå½“äº§ç”Ÿé”™è¯¯æ—¶ï¼Œè‡ªç„¶ä¸ä¼šæŠ›å‡ºåŸ Promise ä»£ç å¤–éƒ¨ã€‚

çœ‹ä¸ªä¾‹å­ï¼š

```js
try {
  new Promise((resolve, reject) => {
    throw new Error("Whoops!");
  }).catch(alert); // Error: Whoops!
} catch(error) {
  console.log(error) // no happend
}
```

ä½†å®é™…ä¸Š JavaScirpt Promise çš„æ‰§è¡Œè€…ï¼ˆexecutorï¼‰æ˜¯åŒæ­¥æ‰§è¡Œï¼Œè€Œå¤„ç†ç¨‹åºï¼ˆhandlerï¼‰æ˜¯å¼‚æ­¥æ‰§è¡Œã€‚Promise çš„æ‰§è¡Œè€…ï¼ˆexecutorï¼‰å’Œ promise çš„å¤„ç†ç¨‹åºï¼ˆhandlerï¼‰å‘¨å›´æœ‰ä¸€ä¸ªâ€œéšå¼çš„ try..catchâ€ã€‚å¦‚æœå‘ç”Ÿå¼‚å¸¸ï¼Œå®ƒå°±ä¼šè¢«æ•è·ï¼Œè¿™æ ·å°±å¯ä»¥ä¿æŒåœ¨è¯­ä¹‰ä¸Šç›¸åŒäº†ã€‚

å†çœ‹ä¸€ç§æƒ…å†µï¼š

```js
new Promise(function(resolve, reject) {
  setTimeout(() => {
    throw new Error("Whoops!");
  }, 1000);
}).catch(alert);
```

ä¸Šé¢çš„é”™è¯¯ä¸ä¼šè¢« Promise æ•è·ï¼ŒsetTimeout ä¹Ÿæ˜¯ä¸€ç§å¼‚æ­¥æ“ä½œï¼Œæ•…ä¸åœ¨ Promise çš„å¼‚æ­¥å†…éƒ¨è‡ªç„¶æ— æ³•æ•è·ã€‚

JavaScript å¼•æ“ä¼šè·Ÿè¸ªæœªå¤„ç†çš„ rejectionï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ä¼šç”Ÿæˆä¸€ä¸ªå…¨å±€çš„ errorï¼Œåœ¨æµè§ˆå™¨ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ unhandledrejection äº‹ä»¶æ¥æ•è·è¿™ç±» errorï¼š

```js
window.addEventListener('unhandledrejection', function(event) {
  // è¿™ä¸ªäº‹ä»¶å¯¹è±¡æœ‰ä¸¤ä¸ªç‰¹æ®Šçš„å±æ€§ï¼š
  alert(event.promise); // [object Promise] - ç”Ÿæˆè¯¥å…¨å±€ error çš„ promise
  alert(event.reason); // Error: Whoops! - æœªå¤„ç†çš„ error å¯¹è±¡
});

new Promise(function() {
  throw new Error("Whoops!");
}); // æ²¡æœ‰ç”¨æ¥å¤„ç† error çš„ catch
```

### Async/Await

Async/Await æœ¬è´¨ä¸Šæ˜¯ Promise + Generator å¼‚æ­¥æ–¹æ¡ˆæ ‡å‡†åŒ–ï¼Œå¯ä»¥å®ç°ç”¨åŒæ­¥çš„å†™æ³•ï¼Œç¼–å†™å¼‚æ­¥ä»£ç çš„æ•ˆæœã€‚

è‡ªæ‰€ä»¥ Generator èƒ½ç”¨åœ¨å¼‚æ­¥æ–¹æ¡ˆä¸­ï¼Œå¯ä»¥è¯´ JavaScript ä¸­çš„ Generator æ˜¯ä¸€ç§æ— æ ˆå¼åç¨‹ã€‚æŒ‰è°ƒç”¨æ ˆåˆ†ç±»ï¼Œæœ‰æ ˆåç¨‹ï¼ˆStackful Coroutineï¼‰ï¼šæ¯ä¸ªåç¨‹éƒ½æœ‰è‡ªå·±çš„è°ƒç”¨æ ˆï¼Œç±»ä¼¼äºçº¿ç¨‹çš„è°ƒç”¨æ ˆï¼›è€Œæ— æ ˆåç¨‹ï¼ˆStackless Coroutineï¼‰ï¼šåç¨‹æ²¡æœ‰è‡ªå·±çš„è°ƒç”¨æ ˆï¼ŒæŒ‚èµ·ç‚¹çš„çŠ¶æ€é€šè¿‡çŠ¶æ€æœºå’Œé—­åŒ…ç­‰è¯­æ³•æ¥å®ç°ã€‚

æ— æ ˆåç¨‹æ„å‘³ç€æ— æ³•åœ¨å†…éƒ¨å‡½æ•°ä¸­æŒ‚èµ·åç¨‹ï¼Œä¸”å…·æœ‰**ä¼ æŸ“æ€§**ï¼šè¦æ±‚æ‰€æœ‰è°ƒç”¨é“¾æ¡ä¸­çš„å‡½æ•°éƒ½å¿…é¡»æ”¯æŒå¼‚æ­¥ç‰¹æ€§ï¼Œåªæœ‰åœ¨ await ç‚¹æ‰èƒ½åˆ‡æ¢æ§åˆ¶æƒï¼š

```js
const a = () => {
  return 10 + b();
};

const b = () => {
  return 20 + c();
};

const c = async () => {
  let c = await Promise.resolve(30);
  return c;
};

console.log(a()) // 1020[object Promise]
```

åœ¨ `[a,b,c]` çš„è°ƒç”¨é“¾ä¸­ï¼Œc æ˜¯ä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼Œå½“ c è¢« await æ“ä½œæŒ‚èµ·æ—¶ï¼Œæ•´ä¸ªè°ƒç”¨æ ˆå¹¶ä¸ä¼šè¢«æŒ‚èµ·ï¼Œè€Œæ˜¯ç»§ç»­æ‰§è¡Œå®Œæ¯•ï¼Œc ç›´æ¥è¿”å›ä¸€ä¸ª Promiseã€‚ä¸ºäº†è®©æ•´ä¸ªè°ƒç”¨é“¾éƒ½èƒ½è¢«æŒ‚èµ·ï¼Œæ‰€æœ‰å‡½æ•°éƒ½å¿…é¡»è½¬æˆå¼‚æ­¥å‡½æ•°ï¼Œå¹¶ä¸”ä½¿ç”¨ await æŒ‚èµ·è°ƒç”¨ç‚¹ï¼š

```js
const a = async () => {
  return 10 + await b();
};

const b = async () => {
  return 20 + await c();
};

const c = async () => {
  let c = await Promise.resolve(30);
  return c;
};

console.log(await a()) // 60
```

è°ƒç”¨æ ˆæ‰§è¡Œå®Œæ¯•å°±ä¼šæ¶ˆå¤±ï¼Œè€Œæ¯ä¸ªå¼‚æ­¥å‡½æ•°æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„åç¨‹ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªçŠ¶æ€æœºï¼Œåªä¼šè®°å½•æŒ‚èµ·æ—¶çš„çŠ¶æ€ç‚¹ï¼Œè€Œæœ‰æ ˆåç¨‹åˆ™ä¼šè®°å½•è‡ªå·±çš„è°ƒç”¨æ ˆã€‚

#### Async/Await çš„å®ç°åŸç†

æœ¬è´¨ä¸Šæ˜¯æŠŠ Async å‡½æ•°ç¼–è¯‘æˆ Generator åç¨‹å’Œç”Ÿæˆä¸€ä¸ªåŸºäº Promise çš„è°ƒåº¦å™¨å»è¿­ä»£å®Œæˆ Generator å‡½æ•°ã€‚

```js
async function g() {
    let res = await 1;
    const fn = () => { throw 2 }
    res += await fn();
    return res;
}
```

æŠŠ async å‡½æ•°è½¬æˆç”Ÿæˆå™¨ï¼š

- function* ç›¸å½“äº async
- yield ç›¸å½“äº await

```js
const _g = async(function* () {
    let res = yield 1;
    const fn = () => Promise.reject(2)
    res += yield fn();
    return res;
})

function async(gen) {
  function _async() {
      return new Promise((resolve, reject) => {
          const g = gen()
          const next = (val, key = "next") => {
              try {
                const { value, done } = g[key](val)

                if (done) {
                    resolve(value)
                } else {
                    Promise.resolve(value).then(
                        (val) => next(val),
                        (e) => next(e, "throw")
                    )
                }
              } catch (error) {
                  reject(error)
              }
          }

          next()
      })
  }

  return _async
}
```

å¯¹æ¯”ä¸‹ Babel ç¼–è¯‘ç”Ÿæˆçš„ä»£ç ï¼š

```js
"use strict";

function asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) {
  try {
    var info = gen[key](arg);
    var value = info.value;
  } catch (error) {
    reject(error);
    return;
  }
  if (info.done) {
    resolve(value);
  } else {
    Promise.resolve(value).then(_next, _throw);
  }
}

function _asyncToGenerator(fn) {
  return function () {
    var self = this,
      args = arguments;
    return new Promise(function (resolve, reject) {
      var gen = fn.apply(self, args);
      function _next(value) {
        asyncGeneratorStep(gen, resolve, reject, _next, _throw, "next", value);
      }
      function _throw(err) {
        asyncGeneratorStep(gen, resolve, reject, _next, _throw, "throw", err);
      }
      _next(undefined);
    });
  };
}

function g() {
  return _g.apply(this, arguments);
}

function _g() {
  _g = _asyncToGenerator(function* () {
    let res = yield 1;

    const fn = () => {
      throw 2;
    };

    res += yield fn();
    return res;
  });
  return _g.apply(this, arguments);
}
```

## å‚è€ƒ

- [å¹¶å‘ç¼–ç¨‹æ¨¡å‹ï¼šäº‹ä»¶é©±åŠ¨ vs çº¿ç¨‹](https://zhuanlan.zhihu.com/p/32961438)
- [ä½¿ç”¨ promise è¿›è¡Œé”™è¯¯å¤„ç†](https://zh.javascript.info/promise-error-handling)
- é˜®ä¸€å³°ã€Šæ·±å…¥æŒæ¡ ECMAScript 6 å¼‚æ­¥ç¼–ç¨‹ã€‹
- [100 è¡Œä»£ç å®ç° Promises/A+ è§„èŒƒ](https://zhuanlan.zhihu.com/p/83965949)