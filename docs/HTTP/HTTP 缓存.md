---
release: true
tags:
  - http
  - ç¼“å­˜
  - æµè§ˆå™¨
desc: æ€»ç»“ http ç¼“å­˜ã€ç¼“å­˜ç›¸å…³æ§åˆ¶è®¾ç½®åŠå‰ç«¯ç¼“å­˜æœ€ä½³å®è·µ
---

# HTTP ç¼“å­˜

- HTTP ç¼“å­˜
  - [Cache-Control](#cache-control)
  - ç¼“å­˜ä½ç½®
    - [ä»£ç†ç¼“å­˜](#ä»£ç†ç¼“å­˜)
      - [Varyï¼šç¼“å­˜éªŒè¯å™¨](#Varyï¼šç¼“å­˜éªŒè¯å™¨)
    - [æµè§ˆå™¨ç¼“å­˜](#æµè§ˆå™¨ç¼“å­˜)
  - [åå•†ç¼“å­˜](#åå•†ç¼“å­˜)
  - [ç¼“å­˜è®¾ç½®æ§åˆ¶](#ç¼“å­˜è®¾ç½®æ§åˆ¶)
    - [é€šè¿‡ response è¿›è¡Œç¼“å­˜æ§åˆ¶](#é€šè¿‡-response-è¿›è¡Œç¼“å­˜æ§åˆ¶)
    - [é€šè¿‡ request è¿›è¡Œç¼“å­˜æ§åˆ¶](#é€šè¿‡-request-è¿›è¡Œç¼“å­˜æ§åˆ¶)
  - [å‰ç«¯ç¼“å­˜æœ€ä½³å®è·µ](../å‰ç«¯å·¥ç¨‹åŒ–/å‰ç«¯ç¼“å­˜æœ€ä½³å®è·µ.md)
  - SWRï¼šstale-while-revalidate

## Cache-Control

http ä¸­æ§åˆ¶ç¼“å­˜çš„ä¸»è¦å­—æ®µæœ‰ä¸€ä¸‹ä¸‰ä¸ªï¼š

1. Cache-Control(HTTP/1.1ï¼Œä¼˜å…ˆçº§é«˜)
2. Expires(HTTP/1.0)
   > HTTP 1.0 çš„å­—æ®µï¼Œè¡¨ç¤ºç¼“å­˜åˆ°æœŸæ—¶é—´ï¼Œæ˜¯ä¸€ä¸ªç»å¯¹çš„æ—¶é—´ (å½“å‰æ—¶é—´+ç¼“å­˜æ—¶é—´)
3. Pragma: no-cache(ç›¸å½“äº Cache-Control: no-cacheï¼Œä¸»è¦æ˜¯ä¸ºäº†å…¼å®¹ HTTP/1.0)

é‡ç‚¹å­¦ä¹  `Cache-Control`

- Cache-Control
  - no-storeï¼Œä¸å…è®¸å­˜å‚¨ç¼“å­˜èµ„æº
  - no-cacheï¼Œä¸å…è®¸å…ˆä½¿ç”¨ç¼“å­˜èµ„æºï¼Œå¼ºåˆ¶å‘é€è¯·æ±‚ï¼ˆåå•†ç¼“å­˜éªŒè¯ï¼‰
  - max-ageï¼Œç¼“å­˜æ—¶é—´ï¼Œç›¸å¯¹å“åº”æŠ¥æ–‡çš„åˆ›å»ºæ—¶åˆ»
    > å½“æ²¡æœ‰æ˜¾ç¤ºè®¾ç½® cache-control æˆ–æ˜¯ expires æ—¶, å¤§éƒ¨åˆ†æµè§ˆå™¨ä¼šä½¿ç”¨**å¯å‘å¼ç¼“å­˜**, æŠŠèµ„æºç¼“å­˜ä¸‹æ¥; å¦‚æœçœŸçš„ä¸æƒ³ç”¨ç¼“å­˜, è¿˜æ˜¯ä¸»åŠ¨è®¾ç½®ä¸€ä¸‹ cache-control: no-storeã€‚  
    > å¯å‘å¼è®¡ç®—ç¼“å­˜åœ¨ RFC é‡Œçš„å»ºè®®æ˜¯ **(Date - Last-modified) \* 10%**
  - must-revalidateï¼Œå½“ç¼“å­˜å¤±æ•ˆæ—¶å¿…é¡»ä¸å›æºæœåŠ¡å™¨éªŒè¯
    > å½“ç¼“å­˜å¤±æ•ˆæ—¶ï¼Œå…¶å®å¸¦ä¸å¸¦ must-revalidateï¼Œéƒ½ä¼šå‘é€è¯·æ±‚ï¼Œé‚£ä¹ˆ must-revalidate å¥½åƒæ²¡ä»€ä¹ˆä½œç”¨ï¼Ÿä¸»è¦æœ‰ä¸€ä¸‹ä¸¤ä¸ªä½¿ç”¨åœºæ™¯:
    >
    > 1. HTTP è§„èŒƒæ˜¯å…è®¸å®¢æˆ·ç«¯åœ¨æŸäº›ç‰¹æ®Šæƒ…å†µä¸‹ç›´æ¥ä½¿ç”¨è¿‡æœŸç¼“å­˜çš„ï¼Œæ¯”å¦‚æœåŠ¡å™¨å…³é—­æˆ–å¤±å»è¿æ¥ï¼Œå¯¼è‡´è¯·æ±‚å‘é€å¤±è´¥çš„æ—¶å€™ï¼Œå³ä½¿è®¾ç½®äº† `Cache-Control: max-age=0` è¿˜æ˜¯å›ç»§ç»­ä½¿ç”¨ç¼“å­˜ï¼›è¿˜æœ‰æ¯”å¦‚æœ‰é…ç½®ä¸€äº›ç‰¹æ®ŠæŒ‡ä»¤ï¼ˆstale-while-revalidateã€stale-if-error ç­‰ï¼‰çš„æ—¶å€™ä¹Ÿä¼šå¯¼è‡´ç»§ç»­ä½¿ç”¨ç¼“å­˜ï¼Œå¯ä»¥ä½¿ç”¨ must-revalidate è¿›è¡Œé˜»æ­¢ã€‚
    > 2. ä¸ proxy-revalidateï¼ˆä¸‹æ–‡ä»‹ç»ï¼‰åšåŒºåˆ«ï¼Œmust-revalidate å¼ºè°ƒ**å›æºæœåŠ¡å™¨**

## ä»£ç†ç¼“å­˜

![å›¾ 6](./images/6561aa12c52e04d459ba53c9d9eaba278a41bcacba1af8a51f64bda2ecfb6db9.png)

ç¼“å­˜ä»£ç†èº«ä»½ç‰¹æ®Šï¼Œå³æ˜¯å®¢æˆ·ç«¯ä¹Ÿæ˜¯æœåŠ¡ç«¯ï¼Œæ‰€ä»¥è¿˜éœ€è¦æœ‰ä¸€äº›æ–°çš„â€œCache-Controlâ€å±æ€§æ¥å¯¹å®ƒåšç»†è‡´çš„æ§åˆ¶ã€‚

- privateï¼Œè¡¨ç¤ºç¼“å­˜åªèƒ½åœ¨å®¢æˆ·ç«¯ä¿å­˜ï¼Œä¸èƒ½æ”¾åœ¨ä»£ç†ä¸Šä¸åˆ«äººå…±äº«
- publicï¼Œç¼“å­˜å®Œå…¨å¼€æ”¾ï¼Œè°éƒ½å¯ä»¥å­˜ï¼Œè°éƒ½å¯ä»¥ç”¨
- proxy-revalidateï¼Œç¼“å­˜å¤±æ•ˆæ—¶ä»£ç†æœåŠ¡å™¨éªŒè¯å³å¯
- s-maxageï¼Œå•ç‹¬è®¾ç½®ä»£ç†æœåŠ¡å™¨ç¼“å­˜æ—¶é—´ï¼Œä¸ max-age åŒºåˆ«å¼€
- no-transformï¼Œç¦æ­¢ä»£ç†æœåŠ¡å¯¹èµ„æºåšè½¬æ¢

## æµè§ˆå™¨ç¼“å­˜

æµè§ˆå™¨å¯¹èµ„æºçš„ç¼“å­˜ä½ç½®åˆ†ä¸ºï¼š
- å†…å­˜
  - é¢„åŠ è½½å™¨
  - preload æŒ‡ä»¤
- service-work
- http-cache
- push-cache

> âš ï¸ å†…å­˜ç¼“å­˜çš„è¡Œä¸ºï¼Œå„ä¸ªæµè§ˆå™¨å¹¶æ²¡æœ‰ç»Ÿä¸€è§„èŒƒï¼Œè€Œä¸”å†…å­˜ç¼“å­˜å¹¶ä¸å…³æ³¨ HTTP è¯­ä¹‰ï¼Œæµè§ˆå™¨å¯¼èˆªä¸­ä¼šé‡ç”¨èµ„æºï¼Œå³æ˜¯èµ„æºå¸¦æœ‰ `max-age=0` æˆ– `no-cache`ã€‚  
> å”¯ä¸€å¯èƒ½ä¾‹å¤–çš„æ˜¯ `no-store` å†…å­˜ç¼“å­˜åœ¨æŸäº›æƒ…å†µä¸‹ç¡®å®ä¼šéµå®ˆè¯¥æŒ‡ä»¤ã€‚

> HTTP Cache å‡ ä¹éµä» HTTP è§„èŒƒï¼Œä½†æœ‰ä¸€ä¸ªä¾‹å¤–ï¼Œå³æ˜¯èµ„æºå¸¦æœ‰ï¼ŒHTML ä¸­ prefetch æŒ‡ä»¤è·å–çš„èµ„æºä¼šç¼“å­˜åœ¨ HTTP Cache ä¸­ä¸€å®šæ—¶é—´ï¼ˆ5åˆ†é’Ÿï¼‰

æµè§ˆå™¨ http-cache ç­–ç•¥åˆ†ä¸ºä¸¤ç§ï¼šå¼ºç¼“å­˜ã€åå•†ç¼“å­˜

![å›¾ 18](./images/bdc51a403dd95bc66a025a17492f3dab8cd6640484c797b67e2d1e324e3b99b5.png)

1. ç¼“å­˜æŸ¥æ‰¾ï¼šæŸ¥æ‰¾ä¸åˆ°ç›´æ¥å‘é€è¯·æ±‚
2. å¼ºåˆ¶ç¼“å­˜ï¼šé€šè¿‡ Expires å’Œ Cache-Control åˆ¤æ–­ç¼“å­˜æ˜¯å¦å¯ç”¨æ˜¯å¦åˆ°æœŸï¼Œå¦‚æœå¯ç”¨åˆ™ç›´æ¥ä½¿ç”¨ï¼Œå¦åˆ™åå•†ç¼“å­˜
3. [åå•†ç¼“å­˜](#åå•†ç¼“å­˜)ï¼šæœåŠ¡ç«¯è¿”å›èµ„æºæ—¶ä¼šå¸¦æœ‰ Last-modifiedã€ETagä¿¡æ¯ï¼Œå½“åå•†ç¼“å­˜æ—¶ï¼Œå®¢æˆ·ç«¯ç›´æ¥å‘èµ·è¯·æ±‚å¹¶ä¸”æºå¸¦ If-Modified-Since ã€If-None-Match å»è¯·æ±‚åå°ï¼ŒæœåŠ¡å™¨æ ¹æ®æ¡ä»¶è¯·æ±‚å­—æ®µåˆ¤æ–­èµ„æºæ˜¯å¦æ›´æ–°
   - è‹¥èµ„æºæ›´æ–°ï¼Œè¿”å›èµ„æºå’Œ 200 çŠ¶æ€ç 
   - å¦åˆ™ï¼Œè¿”å› 304ï¼Œå‘Šè¯‰æµè§ˆå™¨ç›´æ¥ä»ç¼“å­˜è·å–èµ„æº

### ç”¨æˆ·è¡Œä¸º

> ä»¥ä¸‹ chrome å®ç°æ•ˆæœ

ğŸ’¡ æµè§ˆå™¨æŸäº›ç”¨æˆ·è¡Œä¸ºä¼šåœ¨è¯·æ±‚å¤´å¸¦ä¸Šâ€œç§è´§â€ä»¥æ§åˆ¶ç¼“å­˜ï¼š

1. åœ°å€æ è®¿é—®ï¼Œé“¾æ¥è·³è½¬æ˜¯æ­£å¸¸ç”¨æˆ·è¡Œä¸ºï¼Œå°†ä¼šè§¦å‘æµè§ˆå™¨ç¼“å­˜æœºåˆ¶
2. å‰è¿›åé€€ä¹Ÿä¼šè§¦å‘æµè§ˆå™¨ç¼“å­˜æœºåˆ¶ï¼Œä½†æŸäº›æƒ…å†µæµè§ˆå™¨ä¼šç›´æ¥ç¼“å­˜å†…å­˜åˆ°æ—¶ç›´æ¥è¯»å–å³å¯ï¼ˆ[Back/forward cache](https://web.dev/bfcache/) ï¼‰
3. åˆ·æ–°è¡Œä¸ºä¼šå¯¹ html æ–‡ä»¶è‡ªåŠ¨è¯·æ±‚å¸¦ä¸Š `Cache-Control:max-age=0`
4. å¼ºåˆ·æˆ–è€…ç¦æ­¢ç¼“å­˜æ‰€æœ‰è¯·æ±‚ä¼šå¸¦ä¸Š `Cache-Control: no-cache` ï¼Œå¹¶ä¸”ä¸æºå¸¦ If æ¡ä»¶éªŒè¯ï¼Œå¼ºåˆ¶è¯·æ±‚ï¼Œä¸åšåå•†ã€‚

## åå•†ç¼“å­˜

HTTP åè®®å°±å®šä¹‰äº†ä¸€ç³»åˆ—â€œIfâ€å¼€å¤´çš„â€œæ¡ä»¶è¯·æ±‚â€å­—æ®µï¼Œä¸“é—¨ç”¨æ¥ä¸æœåŠ¡å™¨æ£€æŸ¥éªŒè¯èµ„æºæ˜¯å¦è¿‡æœŸã€‚**å½“è¯·æ±‚å¸¦æœ‰æ¡ä»¶å­—æ®µï¼ŒæœåŠ¡å™¨å°±ä¼šéªŒè¯èµ„æºæ˜¯å¦è¿‡æœŸ**ã€‚

- If-Modified-Since ã€Last-modifiedï¼Œæ ¹æ®æ–‡ä»¶ä¿®æ”¹æ—¥æœŸåšéªŒè¯
- If-None-Match ã€ETagï¼Œ

ETag æ˜¯â€œå®ä½“æ ‡ç­¾â€ï¼ˆEntity Tagï¼‰çš„ç¼©å†™ï¼Œæ˜¯èµ„æºçš„ä¸€ä¸ªå”¯ä¸€æ ‡è¯†ï¼Œæ–‡ä»¶å†…å®¹çš„ hash å€¼ã€‚æ¯” Last-modified åšåˆ¤æ–­æ›´ç²¾å‡†ï¼ŒåšéªŒè¯æ—¶**ä¼˜å…ˆçº§æ¯” Last-modified é«˜**ï¼Œ å› ä¸º

1. Last-Modified çš„æ—¶é—´å•ä½æ˜¯ç§’ï¼Œå¦‚æœæŸä¸ªæ–‡ä»¶åœ¨ 1 ç§’å†…æ”¹å˜äº†å¤šæ¬¡ï¼Œé‚£ä¹ˆä»–ä»¬çš„ Last-Modified å…¶å®å¹¶æ²¡æœ‰ä½“ç°å‡ºæ¥ä¿®æ”¹
2. æœ‰æ—¶ä¸€ä¸ªæ–‡ä»¶å†…å®¹æ²¡ä»€ä¹ˆå˜åŒ–ï¼Œä½†ä¿®æ”¹æ—¶é—´å‘ç”Ÿäº†å˜åŒ–ã€‚

ETag è¿˜æœ‰â€œå¼ºâ€â€œå¼±â€ä¹‹åˆ†ã€‚å¼º ETag è¦æ±‚èµ„æºåœ¨å­—èŠ‚çº§åˆ«å¿…é¡»å®Œå…¨ç›¸ç¬¦ï¼Œå¼± ETag åœ¨å€¼å‰æœ‰ä¸ªâ€œW/â€æ ‡è®°ï¼Œåªè¦æ±‚èµ„æºåœ¨è¯­ä¹‰ä¸Šæ²¡æœ‰å˜åŒ–ï¼Œä½†å†…éƒ¨å¯èƒ½ä¼šæœ‰éƒ¨åˆ†å‘ç”Ÿäº†æ”¹å˜ï¼ˆä¾‹å¦‚ HTML é‡Œçš„æ ‡ç­¾é¡ºåºè°ƒæ•´ï¼Œæˆ–è€…å¤šäº†å‡ ä¸ªç©ºæ ¼ï¼‰ã€‚

ETag å·¥ä½œåŸç†ï¼š

![å›¾ 7](./images/afaff54aeae0a40176e285f89da7fe10d6a1cd77a34b4da13dcb4ffb3b6b67b4.png)

Last-modified ä¹ŸåŒæ ·ç±»ä¼¼ã€‚

## ç¼“å­˜æ§åˆ¶

### é€šè¿‡ response è¿›è¡Œç¼“å­˜æ§åˆ¶

![](./images/server-cache-control.svg)  

### é€šè¿‡ request è¿›è¡Œç¼“å­˜æ§åˆ¶

`Cache-Control` æ˜¯ä¸ªé€šç”¨å­—æ®µï¼Œå®¢æˆ·ç«¯ä¹Ÿå¯ä»¥å‘é€é™„å¸¦ `Cache-Control` ç¼“å­˜æŒ‡ä»¤çš„è¯·æ±‚ï¼ˆä½†æµè§ˆå™¨å¯¹è¯·æ±‚ç¼“å­˜æ§åˆ¶çš„æ”¯æŒæœ‰é™ï¼Œæ¯”å¦‚ä»…æ”¯æŒ `Cache-Control: max-age=0` æˆ–è€… `Cache-Control: no-cache` å»åšåˆ·æ–°ï¼‰ã€‚

![å›¾ 1](./images/9b4fa558a294f0716e7dad1d5d8e20b9ffdd5056ac5ad2efa02d3c2ed9cc0756.png)

- no-cacheï¼Œä¸ä½¿ç”¨ç¼“å­˜ï¼Œç›´æ¥å‘é€è¯·æ±‚
- max-staleï¼Œè¡¨æ˜å®¢æˆ·ç«¯æ„¿æ„æ¥æ”¶ä¸€ä¸ªè¶…è¿‡æŒ‡å®šè¿‡æœŸæ—¶é—´èŒƒå›´å†…çš„èµ„æºï¼Œæ¯”å¦‚ `max-stale: 5` è¿‡æœŸå 5 ç§’å†…éƒ½å¯ä»¥
- min-freshï¼Œç›¸å½“äºç¼©çŸ­è¿‡æœŸæ—¶é—´ï¼Œæ¯”å¦‚ `min-freshï¼š5`ï¼Œåªå…è®¸åˆ°æœŸå‰ 5 ç§’ä¹‹å‰çš„æ—¶é—´å†…
- only-if-cachedï¼Œè¡¨ç¤ºåªæ¥å—ä»£ç†ç¼“å­˜çš„æ•°æ®ï¼Œä¸æ¥å—æºæœåŠ¡å™¨çš„å“åº”
- no-transformï¼Œç¦æ­¢ä»£ç†æœåŠ¡å¯¹èµ„æºåšè½¬æ¢

## Varyï¼šç¼“å­˜éªŒè¯å™¨

URL åŸåˆ™ä¸Šæ˜¯ä¸€ç§ç½‘ç»œä¸Šçš„èµ„æºæ¦‚å¿µï¼ŒåŒä¸ª URL å¯ä»¥æœ‰å¤šç§èµ„æºç‰ˆæœ¬å½¢å¼ã€‚

![å›¾ 10](./images/a88d34744c98992ce0bd38df170fbf74743743e010f0f7e558738bd9d1d72dfd.png)

æ¯”å¦‚ï¼Œä½ å¯ä»¥ `Accept: text/html`ï¼Œä¹Ÿå¯ä»¥ `Accept: text/csv` æ”¹ä¸ºä»¥ä¸åŒçš„æ ¼å¼è·å–ç›¸åŒçš„èµ„æºï¼Œè¿™äº›éƒ½æ˜¯æœåŠ¡å™¨[å†…å®¹åå•†](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Content_negotiation)çš„ç»“æœã€‚

vary è™½ç„¶ä¸æ˜¯ cache-control çš„å±æ€§å€¼ï¼Œæ˜¯å†…å®¹åå•†çš„ç»“æœï¼Œå¸¦åœ¨å“åº”å¤´éƒ¨ï¼Œè¡¨ç¤ºä¸€ä¸ªå†…å®¹ç‰ˆæœ¬ï¼Œå¯åä½œç¼“å­˜å†³ç­–ä¾æ®ã€‚

å¤§å¤šæ•°æµè§ˆå™¨éƒ½æ”¯æŒ vary ç¼“å­˜éªŒè¯ï¼Œä½†è¦æ³¨æ„çš„æ˜¯æµè§ˆå™¨é€šå¸¸ä¸ä¼šå®ç°ä¸ºåŒä¸ª URL å­˜å‚¨å¤šä¸ªå˜ä½“çš„åŠŸèƒ½ï¼Œåªä¼šä¸ºå”¯ä¸€ URL åšå•ä¸€å†…å®¹ç‰ˆæœ¬å­˜å‚¨ï¼›è€Œä»£ç†æœåŠ¡å™¨é€šå¸¸å¯è‡ªå®šä¹‰å®ç°å¯¹åŒä¸ª URL å¤šä¸ª vary ç¼“å­˜ã€‚

ä¸‹å›¾æ˜¯ä»£ç†ç¼“å­˜æ ¹æ® vary ç¼“å­˜ä¾æ®æµç¨‹ï¼š

![å›¾ 9](./images/7d679f31875e7cfb7cc3f3f99efc6030698374dbedcc437da771db25f34c7551.png)

## SWRï¼šstale-while-revalidate

`stale-while-revalidate` æ˜¯ä¸€ç§ç¼“å­˜ç­–ç•¥ï¼šä¼˜å…ˆä½¿ç”¨ç¼“å­˜ï¼Œç„¶åå†æ›´æ–°ç¼“å­˜ã€‚è¿™ä¸ä»¥å¾€å¸¸è§çš„ç¼“å­˜ç­–ç•¥ï¼šâ€œç¼“å­˜ -> è¿‡æœŸ -> æ›´æ–° -> ä½¿ç”¨â€ æœ‰æ‰€ä¸åŒï¼ŒSWRï¼šâ€œç¼“å­˜ -> è¿‡æœŸ -> ä½¿ç”¨ -> æ›´æ–°â€ã€‚



## å­¦ä¹ å‚è€ƒ

- [MDN HTTP ç¼“å­˜](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Caching#Cache_validation)
- [å¯èƒ½æ˜¯æœ€è¢«è¯¯ç”¨çš„ HTTP å“åº”å¤´ä¹‹ä¸€ Cache-Control: must-revalidate](https://zhuanlan.zhihu.com/p/60357719)
- [understanding-vary-header](https://www.smashingmagazine.com/2017/11/understanding-vary-header/)
- [A Tale of Four Caches](https://calendar.perfplanet.com/2016/a-tale-of-four-caches/)
- [Cache-Control çš„ stale-while-revalidate æŒ‡ä»¤](https://zhuanlan.zhihu.com/p/64694485)


- API
- core
  - ç¼“å­˜è¯·æ±‚ã€ç¼“å­˜ç­–ç•¥
    - swr
  - è¯·æ±‚ç®¡é“
    - å»é™¤é‡å¤è¯·æ±‚
    - retry
      - èšç„¦æ—¶é‡æ–°éªŒè¯
      - ç½‘ç»œæ¢å¤æ—¶é‡æ–°éªŒè¯
      - æ™ºèƒ½é”™è¯¯é‡è¯•
      - è½®è¯¢
    - ä¸­æ–­
  - Optimistic UI
- adapter
- netã€cache


