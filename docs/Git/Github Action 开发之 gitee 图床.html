<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Github Action 开发之 gitee 图床 | Laoergege Blog</title>
    <meta name="description" content="Just For Fun">
    <meta name="generator" content="VuePress 1.4.0">
    
    
    <link rel="preload" href="/assets/css/0.styles.9970a1b7.css" as="style"><link rel="preload" href="/assets/js/app.41194af9.js" as="script"><link rel="preload" href="/assets/js/2.a658ac31.js" as="script"><link rel="preload" href="/assets/js/4.bfb1630f.js" as="script"><link rel="prefetch" href="/assets/js/10.587f41ab.js"><link rel="prefetch" href="/assets/js/11.d5630b61.js"><link rel="prefetch" href="/assets/js/12.afdc1c7f.js"><link rel="prefetch" href="/assets/js/13.7f9979cf.js"><link rel="prefetch" href="/assets/js/14.10093347.js"><link rel="prefetch" href="/assets/js/15.e14c643e.js"><link rel="prefetch" href="/assets/js/16.2b4d06f8.js"><link rel="prefetch" href="/assets/js/17.70062b4f.js"><link rel="prefetch" href="/assets/js/18.c4503f65.js"><link rel="prefetch" href="/assets/js/19.a039f35c.js"><link rel="prefetch" href="/assets/js/20.df5935b2.js"><link rel="prefetch" href="/assets/js/21.229165c6.js"><link rel="prefetch" href="/assets/js/22.b3162ee8.js"><link rel="prefetch" href="/assets/js/23.1e86b890.js"><link rel="prefetch" href="/assets/js/24.4da11692.js"><link rel="prefetch" href="/assets/js/25.e4043ec4.js"><link rel="prefetch" href="/assets/js/26.df80a137.js"><link rel="prefetch" href="/assets/js/27.d2d2bca2.js"><link rel="prefetch" href="/assets/js/28.1970b434.js"><link rel="prefetch" href="/assets/js/29.10cd531e.js"><link rel="prefetch" href="/assets/js/3.cf3bd797.js"><link rel="prefetch" href="/assets/js/30.c6f2f1f4.js"><link rel="prefetch" href="/assets/js/31.f8d9c835.js"><link rel="prefetch" href="/assets/js/32.b37911df.js"><link rel="prefetch" href="/assets/js/33.78ded2c8.js"><link rel="prefetch" href="/assets/js/34.4423d14a.js"><link rel="prefetch" href="/assets/js/35.e27feb1c.js"><link rel="prefetch" href="/assets/js/36.e09ef9fc.js"><link rel="prefetch" href="/assets/js/37.99dade1f.js"><link rel="prefetch" href="/assets/js/38.620922e9.js"><link rel="prefetch" href="/assets/js/39.51a56934.js"><link rel="prefetch" href="/assets/js/40.c2920ff6.js"><link rel="prefetch" href="/assets/js/41.f2b12beb.js"><link rel="prefetch" href="/assets/js/42.7b4fbb96.js"><link rel="prefetch" href="/assets/js/43.68ad200c.js"><link rel="prefetch" href="/assets/js/44.66c4fb87.js"><link rel="prefetch" href="/assets/js/45.ce0a62b7.js"><link rel="prefetch" href="/assets/js/46.b682221a.js"><link rel="prefetch" href="/assets/js/47.08691391.js"><link rel="prefetch" href="/assets/js/48.afb6e696.js"><link rel="prefetch" href="/assets/js/49.95614cce.js"><link rel="prefetch" href="/assets/js/5.330519c2.js"><link rel="prefetch" href="/assets/js/50.9b680cd5.js"><link rel="prefetch" href="/assets/js/51.418414f4.js"><link rel="prefetch" href="/assets/js/6.962979d5.js"><link rel="prefetch" href="/assets/js/7.791676c2.js"><link rel="prefetch" href="/assets/js/8.59ef6df6.js"><link rel="prefetch" href="/assets/js/9.00cf3f65.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9970a1b7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Laoergege Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/JavaScript/" class="nav-link">
  JavaScript
</a></div><div class="nav-item"><a href="/NodeJS/" class="nav-link">
  NodeJS
</a></div><div class="nav-item"><a href="/Git/" class="nav-link router-link-active">
  Git
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/JavaScript/" class="nav-link">
  JavaScript
</a></div><div class="nav-item"><a href="/NodeJS/" class="nav-link">
  NodeJS
</a></div><div class="nav-item"><a href="/Git/" class="nav-link router-link-active">
  Git
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Git 博客开发系列</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Git/使用 GithubPage、GithubAction、VuePress 搭建个人博客.html" class="sidebar-link">/Git/使用 GithubPage、GithubAction、VuePress 搭建个人博客.html</a></li></ul></section></li><li><a href="/Git/GithubAction.html" class="sidebar-link">知识体系</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="github-action-开发之-gitee-图床"><a href="#github-action-开发之-gitee-图床" class="header-anchor">#</a> Github Action 开发之 gitee 图床</h1> <p>一般情况，笔者喜欢将图片和文件置于同个项目中，写作的时候方便直接引用显示，构建时替换成 Github Raw 线上地址。但由于国内访问 Github 上仓库的图片速度是比较慢的，使用 Github 作为图床是不太理想。我们可以使用国内 Gitee 作为图床，Gitee 的访问速度相对 Github 快。本文中笔者将使用开发一个 Github Action，用于将项目中指定的图片文件夹同步到 Gitee 上。</p> <h2 id="修改-vuepress-webpack-构建配置"><a href="#修改-vuepress-webpack-构建配置" class="header-anchor">#</a> 修改 vuepress webpack 构建配置</h2> <p>根据上述的策略，我们在项目中创建一个 <code>src/images</code> 目录用于存放图片，静态写作时，我们只需要相对引用图片，笔者用 vscode 及相关 markdown 插件进行编写及同步预览。有时我们也需要线下 vuepress dev 开发模式，查看效果如何，通过查看 vuepress 源码，了解 vuepress 构建时使用 <a href="https://github.com/webpack-contrib/url-loader" target="_blank" rel="noopener noreferrer">url-loader<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 对图片资源进行处理，10KB 大小下的图片转成 base64 嵌入。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// node_modules/@vuepress/core/lib/node/webpack/createBaseConfig.js</span>

config<span class="token punctuation">.</span>module
    <span class="token punctuation">.</span><span class="token function">rule</span><span class="token punctuation">(</span><span class="token string">'images'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token regex">/\.(png|jpe?g|gif)(\?.*)?$/</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'url-loader'</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">loader</span><span class="token punctuation">(</span><span class="token string">'url-loader'</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">options</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          limit<span class="token operator">:</span> inlineLimit <span class="token comment">// 10KB,</span>
          name<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">assets/img/[name].[hash:8].[ext]</span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>这在 dev 模式下依旧符合我们期望，但在 build 模式下构建出来的资源对图片的引用，我们需要构建时替换成 Gitee Raw 线上地址 <code>'https://gitee.com/${user}/${repo}/raw/master/${path}'</code>，我们需要对 vupress webpack config 进行修改。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// vue.config.js</span>

<span class="token operator">...</span>
<span class="token function-variable function"> chainWebpack</span><span class="token operator">:</span><span class="token function"> </span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> isServer<span class="token punctuation">)</span><span class="token parameter"> </span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    config<span class="token punctuation">.</span>module
      <span class="token punctuation">.</span><span class="token function">rule</span><span class="token punctuation">(</span><span class="token string">'images'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    config<span class="token punctuation">.</span>module
      <span class="token punctuation">.</span><span class="token function">rule</span><span class="token punctuation">(</span><span class="token string">'images'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token regex">/\.(png|jpe?g|gif)(\?.*)?$/</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'url-loader'</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">loader</span><span class="token punctuation">(</span><span class="token string">'url-loader'</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">options</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          limit<span class="token operator">:</span> <span class="token number">100</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">,</span> <span class="token comment">// 100KB</span>
          name<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span> <span class="token operator">?</span> <span class="token string">'[name].[hash:8].[ext]'</span> <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">assets/img/[name].[hash:8].[ext]</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
          publicPath<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span> <span class="token operator">?</span> <span class="token constant">GITEE_RWA_URL</span> <span class="token operator">:</span> <span class="token string">'/'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token operator">...</span>
</code></pre></div><p>做完上面，接下来的一个主要需求就是：将 <code>src/images</code> 目录下的图片同步到 Gitee 上。我们可以将这个功能开发成一个 Github Action，方便以后其他项目使用。</p> <h2 id="关于-github-action"><a href="#关于-github-action" class="header-anchor">#</a> 关于 Github Action</h2> <p>Github Action 就像是一个实现某些功能的库，比如说可以读写仓库、发送短信、或者调用 github 或第三方的 API。你能够将某些功能抽成一个 Github Action，使用在你的 workflow 中或者通过公开仓库、 github 商城分享给其他人使用（Docker 实现的 Action 则通过 Docker Hub 等镜像仓库平台分享）。</p> <p>推荐将 Github Action 作为一个独立仓库进行维护，而不是放在在某个应用的仓库中，这样方便<strong>分享、跟踪、迭代</strong>。如果不是想分享，而是想自我单独快速使用，推荐放在 <code>.github/actions</code> 文件下，比如 <code>.github/actions/action-a</code> 和 <code>.github/actions/action-b</code>，并使用相对路径引用。</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">jobs</span><span class="token punctuation">:</span>
  <span class="token key atrule">my_first_job</span><span class="token punctuation">:</span>
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> My first step
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> ./.github/actions/my<span class="token punctuation">-</span>action
</code></pre></div><p>Github Action 分成两类实现：</p> <ul><li>Docker 容器实现，Docker 实现更为强大自由，可以自定义操作系统和工具，但由于构建延迟，Docker 容器操作比JavaScript操作慢。</li> <li>JavaScript 实现，直接运行在机器上，执行速度更快。</li></ul> <p>本次开发中我们选择以 JavaScript 实现的方式。</p> <h2 id="开发-img-to-gitee-action"><a href="#开发-img-to-gitee-action" class="header-anchor">#</a> 开发 img-to-gitee-action</h2> <h3 id="创建项目"><a href="#创建项目" class="header-anchor">#</a> 创建项目</h3> <p>创建项目我们可以使用官方提供的开发模板 <a href="https://github.com/actions/javascript-action" target="_blank" rel="noopener noreferrer">actions/javascript-action<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h4 id="模板调整"><a href="#模板调整" class="header-anchor">#</a> 模板调整</h4> <p>删除多余文件（包括 .github/workflows/test.yml）、调整目录，如下</p> <p><img src="https://gitee.com/laoergege/images/raw/master/20200310140855.b55b4cbc.png" alt="test"></p> <h4 id="action-yml"><a href="#action-yml" class="header-anchor">#</a> action.yml</h4> <p>action.yml 相当 npm 包 package.json ，用于描述 action 包的相关信息。</p> <p>input 大写将被转成小写，input的value将被作为环境变量，格式 <code>INPUT_&lt;VARIABLE_NAME&gt;</code></p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">&quot;img-to-gitee-action&quot;</span>
<span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">&quot;a github action to sync images to gitee&quot;</span>
<span class="token key atrule">inputs</span><span class="token punctuation">:</span>
  <span class="token key atrule">folder</span><span class="token punctuation">:</span>
    <span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">&quot;The files in the folder will be synced to Gitee&quot;</span>
    <span class="token key atrule">required</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">runs</span><span class="token punctuation">:</span>
  <span class="token key atrule">using</span><span class="token punctuation">:</span> <span class="token string">&quot;node12&quot;</span>
  <span class="token key atrule">main</span><span class="token punctuation">:</span> <span class="token string">&quot;src/index.js&quot;</span>
</code></pre></div><p>更多的 action.yml 语法详情参考 <a href="https://help.github.com/en/actions/building-actions/metadata-syntax-for-github-actions" target="_blank" rel="noopener noreferrer">Metadata syntax for GitHub Actions<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h3 id="安装-github-actions-toolkit"><a href="#安装-github-actions-toolkit" class="header-anchor">#</a> 安装 GitHub Actions Toolkit</h3> <p><a href="https://github.com/actions/toolkit" target="_blank" rel="noopener noreferrer">GitHub Actions Toolkit<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 是 Github 提供的一些列开发工具包用于 action 开发，并且提供各种模板有 JavaScript 开发项目模板和 Typescript 项目模板等。</p> <h3 id="代码实现"><a href="#代码实现" class="header-anchor">#</a> 代码实现</h3> <h3 id="readme"><a href="#readme" class="header-anchor">#</a> README</h3> <p>创建一个标准的 Action README</p> <p>A detailed description of what the action does.
Required input and output arguments.
Optional input and output arguments.
Secrets the action uses.
Environment variables the action uses.
An example of how to use your action in a workflow.</p> <p><a href="https://help.github.com/en/actions/building-actions/creating-a-javascript-action#create-a-readme" target="_blank" rel="noopener noreferrer">参考<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h3 id="代码提交及版本管理"><a href="#代码提交及版本管理" class="header-anchor">#</a> 代码提交及版本管理</h3> <h4 id="release-分支"><a href="#release-分支" class="header-anchor">#</a> release 分支</h4> <h4 id="打包"><a href="#打包" class="header-anchor">#</a> 打包</h4> <p>action 在 workflow 中作为一个单独的运行程序，所以我们需要将它及其依赖一同打包。
<a href="https://github.com/zeit/ncc" target="_blank" rel="noopener noreferrer">zeit/ncc<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 是一个快速的零配置且内置支持 typescript 的 node module 打包工具。</p> <div class="language- extra-class"><pre class="language-text"><code>...
&quot;package&quot;: &quot;ncc build index.js -o dist&quot;,
...
</code></pre></div><h3 id="在-workflow-中测试你的-action"><a href="#在-workflow-中测试你的-action" class="header-anchor">#</a> 在 workflow 中测试你的 action</h3> <p>私有 action</p> <h3 id="发布-github-marketplace"><a href="#发布-github-marketplace" class="header-anchor">#</a> 发布 Github Marketplace</h3> <p>https://help.github.com/en/actions/building-actions/publishing-actions-in-github-marketplace</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.41194af9.js" defer></script><script src="/assets/js/2.a658ac31.js" defer></script><script src="/assets/js/4.bfb1630f.js" defer></script>
  </body>
</html>
