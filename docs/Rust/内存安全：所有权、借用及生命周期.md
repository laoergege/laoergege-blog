---
tags:
 - rust
---

# 内存安全：所有权、借用及生命周期

- 所有权及生命周期
  - **Rust 通过单一所有权来限制任意引用的行为**：一个值只能被一个变量所拥有，这个变量被称为所有者，杜绝多重引用带来的不可预测
  - 一个值同一时刻只能有一个所有者
    - 值使用：值只能所有者使用，当想通过其他方式使用呢？
      - Move（默认）：即**所有权转移**，一旦发生赋值、传惨或返回值时所有权就会被转移，旧变量将不再有效
      - Copy：如果值的类型实现了 **Copy trait**，就会自动使用 Copy 语义进行按位拷贝（浅拷贝），产生新的值，否则使用 Move 语义进行移动
        - 那么 Rust 中哪些类型实现了 Copy trait 呢？
      - Borrow：将创建一个引用的行为称为**借用**
        - `&T：不可变借用`、`&mut T: 可变借用`
        - 借用规则：
          - 在同一作用域只能有一个可变借用
          - 在同一作用域，不能在不可变引用前使用可变引用
          - 禁止值的声明周期导致空引用
  - 生命周期：当程序离开所有权者的作用域，其拥有的值被丢弃

## 所有权转移

```rust
fn move_var_ownership() {
    let num = 123;
    let num2 = num;
    println!("{}", num); // success

    let data = vec![1, 2, 3, 4];
    //移动：所有权一旦转移，旧变量将不再有效
    let data1 = data;
    println!("data1: {:?}", data); // error
}
```

##  借用

## 生命周期

当程序离开 "hello" 所有者变量 s 所在生命周期（作用域），其拥有的值被丢弃。

```rust
fn main() {
    let s_ref;                                   ——————————————————————                      
    {                                                                 ｜
        let s = String::from("hello");   ----------                   ｜ 
                                                  |                   ｜
                                                  s 生命周期范围        s_ref 生命周期范围
        s_ref = &s;                      _________|                   ｜ 
    }                                                                 ｜ 
    println!("{}", s_ref);                       ——————————————————————
}
```