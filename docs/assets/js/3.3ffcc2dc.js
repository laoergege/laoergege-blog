(window.webpackJsonp=window.webpackJsonp||[]).push([[3],{322:function(t,s){t.exports="http://images.laoergege.cn/images/actions-toolkit_20200406200055.png"},323:function(t,s){t.exports="http://images.laoergege.cn/images/use-template_20200406200309.png"},324:function(t,s){t.exports="http://images.laoergege.cn/images/sync-to-qiniu-action-design.svg"},349:function(t,s,a){"use strict";a.r(s);var n=a(33),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h1",{attrs:{id:"开发一个七牛图床的-githubaction"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#开发一个七牛图床的-githubaction"}},[t._v("#")]),t._v(" 开发一个七牛图床的 GithubAction")]),t._v(" "),n("p",[t._v("笔者喜欢将图片和文件置于同个项目中，写作的时候方便直接相对引用显示，构建时替换成 Github Raw 线上地址。但由于国内访问 Github 上仓库的图片速度是比较慢的，使用 Github 作为图床是不太理想。"),n("a",{attrs:{href:"https://www.qiniu.com/",target:"_blank",rel:"noopener noreferrer"}},[t._v("七牛云"),n("OutboundLink")],1),t._v("对注册用户提供了免费 10G 的对象储存，刚好可以用来作为图床。")]),t._v(" "),n("p",[t._v("梳理下本次需求：")]),t._v(" "),n("ol",[n("li",[t._v("源图片文件存储在同项目中，方便写作时或者 vuepress dev 模式下直接预览")]),t._v(" "),n("li",[t._v("源图片文件能够自动上传七牛云")]),t._v(" "),n("li",[t._v("构建成功时 url 自动替换成七牛云对象储存地址")])]),t._v(" "),n("p",[t._v("借此机会，笔者正好学习开发一个 Github Action，能够自动将项目中指定的文件夹（即储存图片的 images 文件夹）的内容同步到七牛对象储存上。")]),t._v(" "),n("h2",{attrs:{id:"开通七牛云服务"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#开通七牛云服务"}},[t._v("#")]),t._v(" 开通七牛云服务")]),t._v(" "),n("h2",{attrs:{id:"vuepress-webpack-构建配置修改"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#vuepress-webpack-构建配置修改"}},[t._v("#")]),t._v(" vuepress webpack 构建配置修改")]),t._v(" "),n("p",[t._v("根据上述的需求，我们在项目中创建一个 "),n("code",[t._v("src/images")]),t._v(" 目录用于存放图片，静态写作时，我们只需要相对引用图片，笔者用 vscode 及相关 markdown 插件进行编写及同步预览。有时我们也需要线下 vuepress dev 开发模式，查看效果如何，通过查看 vuepress 源码，了解 vuepress 构建时使用 "),n("a",{attrs:{href:"https://github.com/webpack-contrib/url-loader",target:"_blank",rel:"noopener noreferrer"}},[t._v("url-loader"),n("OutboundLink")],1),t._v(" 对图片资源进行处理，10KB 大小下的图片转成 base64 嵌入。")]),t._v(" "),n("div",{staticClass:"language-javascript extra-class"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// node_modules/@vuepress/core/lib/node/webpack/createBaseConfig.js")]),t._v("\n\nconfig"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("module\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("rule")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'images'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("test")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token regex"}},[t._v("/\\.(png|jpe?g|gif)(\\?.*)?$/")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("use")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'url-loader'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("loader")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'url-loader'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("options")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n          limit"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" inlineLimit "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 10KB,")]),t._v("\n          name"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token template-string"}},[n("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("assets/img/[name].[hash:8].[ext]")]),n("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),n("p",[t._v("这在 dev 模式下依旧符合我们期望，但在 build 模式下构建出来的资源对图片的引用，我们需要构建时替换成七牛云的外链域名地址，我们需要对 vupress webpack config 进行修改。")]),t._v(" "),n("div",{staticClass:"language-javascript extra-class"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// vue.config.js")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v(" chainWebpack")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v(" ")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("config"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" isServer"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v(" ")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    config"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("module\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("rule")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'images'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("clear")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n    config"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("module\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("rule")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'images'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("test")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token regex"}},[t._v("/\\.(png|jpe?g|gif)(\\?.*)?$/")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("use")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'url-loader'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("loader")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'url-loader'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("options")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n          limit"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1024")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 100KB")]),t._v("\n          name"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" process"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("env"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NODE_ENV")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'production'")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'[name].[hash:8].[ext]'")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token template-string"}},[n("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("assets/img/[name].[hash:8].[ext]")]),n("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n          publicPath"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" process"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("env"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NODE_ENV")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'production'")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("IMG_URL")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/'")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n")])])]),n("p",[t._v("做完上面，接下来的一个主要需求就是：将 "),n("code",[t._v("src/images")]),t._v(" 目录下的图片同步到七牛云对象储存上。笔者将这个功能开发成一个 "),n("code",[t._v("sync-to-qiniu-action")]),t._v(" 的 Github Action，方便以后其他项目使用。")]),t._v(" "),n("h2",{attrs:{id:"sync-to-qiniu-action"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#sync-to-qiniu-action"}},[t._v("#")]),t._v(" sync-to-qiniu-action")]),t._v(" "),n("p",[t._v("This action can synchronize files in the path you specified to qiniu(KODO), including delete, modify, and move&rename operations.")]),t._v(" "),n("p",[n("a",{attrs:{href:"https://github.com/laoergege/sync-to-qiniu-action",target:"_blank",rel:"noopener noreferrer"}},[t._v("项目地址"),n("OutboundLink")],1)]),t._v(" "),n("h3",{attrs:{id:"关于-github-action"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#关于-github-action"}},[t._v("#")]),t._v(" 关于 Github Action")]),t._v(" "),n("p",[t._v("Github Action 就是一个独立功能的脚本，您可以通过编写自定义代码来创建操作某些操作，比如说可以读写仓库、发送短信、或者调用 github 或第三方的 API。然后你可以使用在你的 workflow 中使用本地或者公开仓库，github 商城分享给其他人使用（Docker 实现的 Action 则通过 Docker Hub 等镜像仓库平台分享）的 action。其实 Github Action 类似于 npm 包，只不过用于 Github 的 CI/CD 功能中。")]),t._v(" "),n("p",[t._v("Github Action 分成两类实现：")]),t._v(" "),n("ul",[n("li",[t._v("Docker 容器实现，Docker 实现更为强大自由，可以自定义操作系统和工具，但由于构建延迟，Docker 容器操作比JavaScript操作慢。")]),t._v(" "),n("li",[t._v("JavaScript 实现，直接运行在机器上，执行速度更快（本项目选择 JavaScript Action，故不涉及 Docker Action 相关）。")])]),t._v(" "),n("h3",{attrs:{id:"workflow-中如何使用-action"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#workflow-中如何使用-action"}},[t._v("#")]),t._v(" Workflow 中如何使用 Action")]),t._v(" "),n("p",[t._v("如果 action 是独立公开仓库，你可以使用 "),n("code",[t._v("{owner}/{repo}@{ref}")]),t._v(" 或者 "),n("code",[t._v("{owner}/{repo}/{path}@{ref}")]),t._v(" 去引用")]),t._v(" "),n("div",{staticClass:"language-yml extra-class"},[n("pre",{pre:!0,attrs:{class:"language-yml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("jobs")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("my_first_job")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("steps")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" My first step\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Uses the master branch of a public repository")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("uses")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" actions/heroku@master\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# use a specific version tag of a public repository")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" My second step\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("uses")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" actions/aws@v2.0.1\n")])])]),n("p",[t._v("如果 Action 跟 workflow 是位于统一仓库，你能使用"),n("strong",[t._v("相对项目仓库根目录")]),t._v("去引入 "),n("code",[t._v("./path/to/dir")])]),t._v(" "),n("blockquote",[n("p",[t._v("这里要注意了 ./ 不是 action 文件所在位置，而是仓库根位置")])]),t._v(" "),n("div",{staticClass:"language-yml extra-class"},[n("pre",{pre:!0,attrs:{class:"language-yml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("jobs")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("my_first_job")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("steps")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Check out repository\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("uses")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" actions/checkout@v2\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Use local my"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("action\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("uses")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ./.github/actions/my"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("action\n")])])]),n("p",[t._v("从某个角度来说，githua 上大多数项目都是公开的，故可以直接使用 "),n("code",[t._v("{owner}/{repo}@{ref}")]),t._v(" 或者 "),n("code",[t._v("{owner}/{repo}/{path}@{ref}")]),t._v(" 去引入。")]),t._v(" "),n("p",[t._v("推荐将 Github Action 作为一个独立仓库进行维护，而不是放在在某个应用的仓库中，这样方便"),n("strong",[t._v("分享、跟踪、迭代")]),t._v("。如果不是想分享，而是想自我单独快速使用，推荐放在 "),n("code",[t._v(".github/actions")]),t._v(" 文件下，比如 "),n("code",[t._v(".github/actions/action-a")]),t._v(" 和 "),n("code",[t._v(".github/actions/action-b")]),t._v("，并使用相对路径引用。")]),t._v(" "),n("div",{staticClass:"language-yml extra-class"},[n("pre",{pre:!0,attrs:{class:"language-yml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("jobs")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("my_first_job")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("steps")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" My first step\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("uses")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ./.github/actions/my"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("action\n")])])]),n("h3",{attrs:{id:"action-开发"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#action-开发"}},[t._v("#")]),t._v(" Action 开发")]),t._v(" "),n("p",[t._v("本次开发中我们选择以 JavaScript 实现的 Github Action 方式。")]),t._v(" "),n("p",[n("a",{attrs:{href:"https://github.com/actions/toolkit",target:"_blank",rel:"noopener noreferrer"}},[t._v("actions/toolkit"),n("OutboundLink")],1),t._v(" The GitHub ToolKit for developing GitHub Actions. 官方工具包，不仅提供了常用的开发工具，并且还有项目模板以及指引。")]),t._v(" "),n("p",[n("img",{attrs:{src:a(322),alt:""}})]),t._v(" "),n("p",[t._v("创建项目我们可以使用官方提供的开发模板 "),n("a",{attrs:{href:"https://github.com/actions/javascript-action",target:"_blank",rel:"noopener noreferrer"}},[t._v("actions/javascript-action"),n("OutboundLink")],1)]),t._v(" "),n("p",[t._v("进入模板仓库，点击 "),n("strong",[t._v("Use this template")]),t._v(" 创建模板")]),t._v(" "),n("p",[n("img",{attrs:{src:a(323),alt:""}})]),t._v(" "),n("p",[t._v("创建好模板仓库，我们需要调整修改某些文件，其中最主要的就是 action.yml。")]),t._v(" "),n("h4",{attrs:{id:"action-yml"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#action-yml"}},[t._v("#")]),t._v(" action.yml")]),t._v(" "),n("p",[t._v("action.yml 相当 npm 包 package.json ，用于描述 action 的相关信息。")]),t._v(" "),n("blockquote",[n("p",[n("a",{attrs:{href:"https://help.github.com/en/actions/building-actions/metadata-syntax-for-github-actions",target:"_blank",rel:"noopener noreferrer"}},[t._v("官方 action.yml 语法参考"),n("OutboundLink")],1)])]),t._v(" "),n("div",{staticClass:"language-yml extra-class"},[n("pre",{pre:!0,attrs:{class:"language-yml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'sync-to-qiniu-action'")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("description")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'synchronize the files in the specified path to qiniu'")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("inputs")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("accessKey")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("description")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'qiniu accessKey'")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("required")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("secretKey")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("description")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'qiniu secretKey'")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("required")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("bucket")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("description")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'qiniu bucket'")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("required")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("zone")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("description")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'bucket zone'")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("required")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("path")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("description")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'the path under files you want to upload'")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("required")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("token")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("default")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'a token with access to your repository scoped in as a secret'")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("required")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("fsizeLimit")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("description")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'maximum upload file size limit(byte)'")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("default")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 5 * 1024 * 1024 "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#默认 5M")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("mimeLimit")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("description")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'File MimeType'")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("runs")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("using")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'node12'")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("main")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'dist/index.js'")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("post")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'dist/index.js'")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("branding")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("icon")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'upload-cloud'")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("color")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'blue'")]),t._v("\n")])])]),n("p",[t._v("其中 "),n("code",[t._v("runs.post")]),t._v(" 指定后置处理脚本。与七牛交互的过程是比较耗时的任务，故需要把该 action 作为后置处理。")]),t._v(" "),n("div",{staticClass:"language-javascript extra-class"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// core from actions/core")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 通过 save-state command 保存 isPost 状态")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("core"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("getState")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"isPost"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("main")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  core"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("saveState")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"isPost"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'1'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("h4",{attrs:{id:"sync-to-qiniu-action-设计思路"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#sync-to-qiniu-action-设计思路"}},[t._v("#")]),t._v(" sync-to-qiniu-action 设计思路")]),t._v(" "),n("p",[n("img",{attrs:{src:a(324),alt:"sync-to-qiniu-action 设计思路"}})]),t._v(" "),n("p",[t._v("主要思路如下：")]),t._v(" "),n("ol",[n("li",[t._v("workflow 事件触发")]),t._v(" "),n("li",[t._v("获取近两次 wofkflow 的 commit")]),t._v(" "),n("li",[t._v("diff commit")]),t._v(" "),n("li",[t._v("调用 qiniu 工具完成同步操作")])]),t._v(" "),n("p",[t._v("具体代码实现可参考 "),n("a",{attrs:{href:"https://github.com/laoergege/sync-to-qiniu-action",target:"_blank",rel:"noopener noreferrer"}},[t._v("sync-to-qiniu-action"),n("OutboundLink")],1),t._v("。")]),t._v(" "),n("h3",{attrs:{id:"测试"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#测试"}},[t._v("#")]),t._v(" 测试")]),t._v(" "),n("p",[t._v("一般为了测试我们编写 action 或者 workflow 是否符合期望，我们每次都会提交并推送到 github 服务器去跑 workflow，这是最常规方法。当然我们也可以本地进行单元测试，但是我们可能需要模拟以下环境变量，如")]),t._v(" "),n("ul",[n("li",[t._v("模拟 action 输入")]),t._v(" "),n("li",[t._v("模拟 "),n("a",{attrs:{href:"https://help.github.com/en/actions/configuring-and-managing-workflows/using-environment-variables#default-environment-variables",target:"_blank",rel:"noopener noreferrer"}},[t._v("github 上下文环境变量"),n("OutboundLink")],1)]),t._v(" "),n("li",[t._v("模拟文件系统")]),t._v(" "),n("li",[t._v("模拟 webhook 事件内容（在 workflow 中，GITHUB_EVENT_PATH 变量记录完整的 webhook 事件内容文件存放位置）")])]),t._v(" "),n("p",[t._v("等等...")]),t._v(" "),n("h4",{attrs:{id:"debugging"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#debugging"}},[t._v("#")]),t._v(" Debugging")]),t._v(" "),n("h4",{attrs:{id:"分支及版本管理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#分支及版本管理"}},[t._v("#")]),t._v(" 分支及版本管理")]),t._v(" "),n("blockquote",[n("p",[n("a",{attrs:{href:"https://github.com/actions/toolkit/blob/master/docs/action-versioning.md",target:"_blank",rel:"noopener noreferrer"}},[t._v("Versioning"),n("OutboundLink")],1)])]),t._v(" "),n("div",{staticClass:"language-yml extra-class"},[n("pre",{pre:!0,attrs:{class:"language-yml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("steps")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("uses")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" actions/javascript"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("action@v1        "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# recommended. starter workflows use this")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("uses")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" actions/javascript"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("action@v1.0.0    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# if an action offers specific releases ")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("uses")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" actions/javascript"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("action@41775a4da8ffae865553a738ab8ac1cd5a3c0044 "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# sha")]),t._v("\n")])])]),n("p",[t._v("step 使用 action 中，我们可以在 "),n("code",[t._v("ower/repo")]),t._v(" 后指定 "),n("code",[t._v("@ref")]),t._v(" 版本，ref 可以是一个 "),n("strong",[t._v("git 分支")]),t._v("、"),n("strong",[t._v("tag")]),t._v(" 甚至 "),n("strong",[t._v("git 对象的 SHA")]),t._v("。")]),t._v(" "),n("h3",{attrs:{id:"发布-github-marketplace"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#发布-github-marketplace"}},[t._v("#")]),t._v(" 发布 Github Marketplace")]),t._v(" "),n("p",[n("a",{attrs:{href:"https://help.github.com/en/actions/building-actions/publishing-actions-in-github-marketplace",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://help.github.com/en/actions/building-actions/publishing-actions-in-github-marketplace"),n("OutboundLink")],1)]),t._v(" "),n("blockquote",[n("p",[t._v("官方教程 "),n("a",{attrs:{href:"https://github.com/actions/toolkit/blob/master/docs/github-package.md",target:"_blank",rel:"noopener noreferrer"}},[t._v("Creating an Action using the GitHub Context"),n("OutboundLink")],1)])])])}),[],!1,null,null,null);s.default=e.exports}}]);